<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News - AIæ–°é—»èšåˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            text-align: center;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filters select, .filters input {
            padding: 8px 12px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filters button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .filters button:hover {
            background: #5568d3;
        }
        
        .filters button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #trigger-scrape-btn {
            background: #28a745 !important;
        }
        
        #trigger-scrape-btn:hover:not(:disabled) {
            background: #218838 !important;
        }
        
        #trigger-scrape-btn.loading {
            background: #ffc107 !important;
            color: #333;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .news-list {
            display: grid;
            gap: 20px;
        }
        
        .news-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .news-card.featured {
            border-left: 4px solid #667eea;
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .news-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            flex: 1;
        }
        
        .news-title a {
            color: #333;
            text-decoration: none;
        }
        
        .news-title a:hover {
            color: #667eea;
        }
        
        .news-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .news-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }
        
        .badge.category {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge.source {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .badge.featured {
            background: #fff3e0;
            color: #e65100;
        }
        
        .score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .news-summary {
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover {
            background: #f5f5f5;
        }
        
        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ¤– AI News</h1>
            <p>æ¯æ—¥AIæ–°é—»èšåˆ - äº†è§£å…¨çƒAIå…³é”®äº‹ä»¶</p>
        </div>
    </header>
    
    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3 id="total-news">-</h3>
                <p>æ€»æ–°é—»æ•°</p>
            </div>
            <div class="stat-card">
                <h3 id="today-news">-</h3>
                <p>ä»Šæ—¥æ–°é—»</p>
            </div>
            <div class="stat-card">
                <h3 id="week-news">-</h3>
                <p>æœ¬å‘¨æ–°é—»</p>
            </div>
            <div class="stat-card">
                <h3 id="avg-score">-</h3>
                <p>å¹³å‡è¯„åˆ†</p>
            </div>
        </div>
        
        <div class="filters">
            <select id="category-filter">
                <option value="">æ‰€æœ‰åˆ†ç±»</option>
            </select>
            <select id="source-filter">
                <option value="">æ‰€æœ‰æ¥æº</option>
            </select>
            <select id="featured-filter">
                <option value="">å…¨éƒ¨</option>
                <option value="true">ä»…ç²¾é€‰</option>
            </select>
            <input type="number" id="days-filter" placeholder="æœ€è¿‘Nå¤©" min="1" max="30">
            <button onclick="applyFiltersAndLoad(1)">ç­›é€‰</button>
            <button onclick="resetFilters()">é‡ç½®</button>
            <button id="trigger-scrape-btn" onclick="triggerScrape()" style="background: #28a745; margin-left: 10px;">
                ğŸ”„ ç«‹å³æŠ“å–
            </button>
        </div>
        
        <div id="news-container">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>
    
    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let currentFilters = {};
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats/overview`);
                const data = await response.json();
                
                document.getElementById('total-news').textContent = data.total_news || 0;
                document.getElementById('today-news').textContent = data.today_news || 0;
                document.getElementById('week-news').textContent = data.week_news || 0;
                document.getElementById('avg-score').textContent = (data.average_score || 0).toFixed(2);
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½åˆ†ç±»å’Œæ¥æº
        async function loadFilters() {
            try {
                const [categoriesRes, sourcesRes] = await Promise.all([
                    fetch(`${API_BASE}/news/categories/list`),
                    fetch(`${API_BASE}/news/sources/list`)
                ]);
                
                const categories = await categoriesRes.json();
                const sources = await sourcesRes.json();
                
                const categorySelect = document.getElementById('category-filter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
                
                const sourceSelect = document.getElementById('source-filter');
                sources.forEach(src => {
                    const option = document.createElement('option');
                    option.value = src.name;
                    option.textContent = src.name;
                    sourceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ–°é—»åˆ—è¡¨
        async function loadNews(page = 1) {
            currentPage = page;
            const container = document.getElementById('news-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams();
                params.append('page', page.toString());
                params.append('page_size', '20');
                
                // æ·»åŠ ç­›é€‰æ¡ä»¶
                if (currentFilters.category) params.append('category', currentFilters.category);
                if (currentFilters.source) params.append('source', currentFilters.source);
                if (currentFilters.featured) params.append('featured', currentFilters.featured);
                if (currentFilters.days) params.append('days', currentFilters.days);
                
                const response = await fetch(`${API_BASE}/news/?${params.toString()}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const news = await response.json();
                
                if (!Array.isArray(news)) {
                    throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                if (news.length === 0) {
                    container.innerHTML = '<div class="error">æš‚æ— æ–°é—»æ•°æ®</div>';
                    return;
                }
                
                container.innerHTML = news.map(item => {
                    // å®‰å…¨è½¬ä¹‰HTML
                    const escapeHtml = (text) => {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    const title = escapeHtml(item.title || 'æ— æ ‡é¢˜');
                    const summary = item.summary ? escapeHtml(item.summary) : '';
                    const category = item.category_name || 'æœªåˆ†ç±»';
                    const source = item.source_name || 'æœªçŸ¥æ¥æº';
                    const date = item.published_at ? new Date(item.published_at).toLocaleDateString('zh-CN') : '';
                    const score = item.importance_score ? (item.importance_score * 100).toFixed(0) : '0';
                    const url = item.url || '#';
                    
                    return `
                        <div class="news-card ${item.is_featured ? 'featured' : ''}">
                            <div class="news-header">
                                <div style="flex: 1;">
                                    <h2 class="news-title">
                                        <a href="${url}" target="_blank">${title}</a>
                                    </h2>
                                    <div class="news-meta">
                                        <span class="badge category">${category}</span>
                                        <span class="badge source">${source}</span>
                                        ${item.is_featured ? '<span class="badge featured">ç²¾é€‰</span>' : ''}
                                        <span>${date}</span>
                                    </div>
                                </div>
                                <div class="score">${score}åˆ†</div>
                            </div>
                            ${summary ? `<div class="news-summary">${summary}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                // æ›´æ–°åˆ†é¡µ
                updatePagination(page);
                
            } catch (error) {
                console.error('åŠ è½½æ–°é—»å¤±è´¥:', error);
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}<br><small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯</small></div>`;
            }
        }
        
        function updatePagination(page) {
            // ç®€åŒ–åˆ†é¡µå®ç°
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <button ${page > 1 ? `onclick="goToPage(${page - 1})"` : 'disabled'}>ä¸Šä¸€é¡µ</button>
                <button class="active">${page}</button>
                <button onclick="goToPage(${page + 1})">ä¸‹ä¸€é¡µ</button>
            `;
        }
        
        function resetFilters() {
            document.getElementById('category-filter').value = '';
            document.getElementById('source-filter').value = '';
            document.getElementById('featured-filter').value = '';
            document.getElementById('days-filter').value = '';
            currentFilters = {};
            loadNews(1);
        }
        
        // åº”ç”¨ç­›é€‰æ¡ä»¶å¹¶åŠ è½½æ–°é—»ï¼ˆä¾›ç­›é€‰æŒ‰é’®ä½¿ç”¨ï¼‰
        function applyFiltersAndLoad(page = 1) {
            const category = document.getElementById('category-filter').value;
            const source = document.getElementById('source-filter').value;
            const featured = document.getElementById('featured-filter').value;
            const days = document.getElementById('days-filter').value;
            
            currentFilters = {};
            if (category) currentFilters.category = category;
            if (source) currentFilters.source = source;
            if (featured) currentFilters.featured = featured;
            if (days) currentFilters.days = days;
            
            // è°ƒç”¨å†…éƒ¨çš„loadNewså‡½æ•°ï¼Œä¸æ˜¯window.loadNews
            loadNews(page);
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢ï¼ˆä¾›åˆ†é¡µæŒ‰é’®ä½¿ç”¨ï¼‰
        function goToPage(page) {
            loadNews(page);
        }
        
        // æ‰‹åŠ¨è§¦å‘çˆ¬å–
        let scrapePollingTimer = null;
        
        async function triggerScrape() {
            const button = document.getElementById('trigger-scrape-btn');
            const originalText = button.textContent;
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.classList.add('loading');
            button.textContent = 'â³ æŠ“å–ä¸­...';
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('å¼€å§‹æŠ“å–æ–°é—»ï¼Œé¢„è®¡1-2åˆ†é’Ÿ...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/admin/scrape/trigger`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // å¼€å§‹è½®è¯¢çŠ¶æ€
                    startPollingStatus(button, originalText);
                } else {
                    throw new Error(result.message || 'å¯åŠ¨å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æŠ“å–å¤±è´¥:', error);
                showNotification(`âŒ æŠ“å–å¤±è´¥: ${error.message}`, 'error');
                button.disabled = false;
                button.classList.remove('loading');
                button.textContent = originalText;
            }
        }
        
        // è½®è¯¢æŠ“å–çŠ¶æ€
        function startPollingStatus(button, originalText) {
            let pollCount = 0;
            const maxPolls = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ2åˆ†é’Ÿï¼‰
            
            scrapePollingTimer = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch(`${API_BASE}/admin/scrape/status`);
                    const status = await response.json();
                    
                    if (status.status === 'completed') {
                        clearInterval(scrapePollingTimer);
                        showNotification(`âœ… æŠ“å–æˆåŠŸï¼æ–°å¢ ${status.saved_count} æ¡æ–°é—»`, 'success');
                        button.disabled = false;
                        button.classList.remove('loading');
                        button.textContent = originalText;
                        // åˆ·æ–°æ•°æ®
                        loadStats();
                        loadNews(1);
                        
                    } else if (status.status === 'failed') {
                        clearInterval(scrapePollingTimer);
                        showNotification(`âŒ æŠ“å–å¤±è´¥: ${status.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        button.disabled = false;
                        button.classList.remove('loading');
                        button.textContent = originalText;
                        
                    } else if (pollCount >= maxPolls) {
                        clearInterval(scrapePollingTimer);
                        showNotification('â±ï¸ æŠ“å–è¶…æ—¶ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ', 'info');
                        button.disabled = false;
                        button.classList.remove('loading');
                        button.textContent = originalText;
                    }
                    // è¿˜åœ¨è¿è¡Œä¸­ï¼Œç»§ç»­ç­‰å¾…
                    
                } catch (error) {
                    console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', error);
                }
            }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç§»é™¤ç°æœ‰é€šçŸ¥
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            // åˆ›å»ºæ–°é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›onclickä½¿ç”¨
        window.applyFiltersAndLoad = applyFiltersAndLoad;
        window.goToPage = goToPage;
        window.triggerScrape = triggerScrape;
        
        // åˆå§‹åŒ– - ç¡®ä¿æŒ‰é¡ºåºåŠ è½½
        (async function init() {
            try {
                // å…ˆåŠ è½½ç­›é€‰é€‰é¡¹
                await loadFilters();
                // ç„¶ååŠ è½½ç»Ÿè®¡å’Œæ–°é—»ï¼ˆå¹¶è¡Œï¼‰
                await Promise.all([
                    loadStats(),
                    loadNews(1)
                ]);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('news-container').innerHTML = 
                    `<div class="error">åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        })();
        
        // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        setInterval(() => {
            loadStats();
            // ä½¿ç”¨å†…éƒ¨çš„loadNewså‡½æ•°ï¼Œä¿æŒå½“å‰ç­›é€‰æ¡ä»¶
            loadNews(currentPage);
        }, 5 * 60 * 1000);
    </script>
</body>
</html>

